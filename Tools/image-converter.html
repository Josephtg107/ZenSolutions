<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Convertidor de Im√°genes - Zen Solutions</title>
  <link rel="icon" href="../Icon/favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles-new.css">
  <link rel="stylesheet" href="freemium-styles.css">
  <style>
    body { min-height: 100vh; margin: 0; }
    .converter-hero {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 6rem 1rem 2.5rem 1rem;
      background: linear-gradient(135deg, rgba(167,139,250,0.10) 0%, rgba(212,255,101,0.10) 100%);
      border-radius: 0 0 2rem 2rem; box-shadow: var(--shadow-md);
      text-align: center;
    }
    .converter-hero h1 { font-size: 2.2rem; font-weight: 800; color: var(--dark-blue); margin: 0 0 .25rem 0; letter-spacing: -0.5px; }
    .converter-hero p { color: var(--gray-700); font-size: 1.1rem; max-width: 720px; }

    .converter-container {
      max-width: 800px; margin: 2rem auto; padding: 0 1rem;
    }
    .converter-card {
      background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--radius-2xl);
      box-shadow: var(--shadow); padding: var(--space-8); margin-bottom: var(--space-6);
    }
    .format-selector {
      display: grid; grid-template-columns: 1fr auto 1fr; gap: var(--space-4); align-items: center;
      margin-bottom: var(--space-6);
    }
    .format-group {
      display: flex; flex-direction: column; gap: var(--space-2);
    }
    .format-group label {
      font-weight: 600; color: var(--dark-blue); font-size: 0.9rem;
    }
    .format-select {
      padding: var(--space-3); border: 2px solid var(--gray-200); border-radius: var(--radius-lg);
      font-size: 1rem; background: var(--white); transition: border-color var(--transition-normal);
    }
    .format-select:focus { outline: none; border-color: var(--primary-purple); }
    .arrow-icon {
      font-size: 1.5rem; color: var(--primary-purple); font-weight: bold;
    }
    .file-upload {
      border: 2px dashed var(--gray-300); border-radius: var(--radius-xl); padding: var(--space-8);
      text-align: center; transition: all var(--transition-normal); cursor: pointer;
      background: var(--gray-50);
    }
    .file-upload:hover { border-color: var(--primary-purple); background: rgba(167,139,250,0.05); }
    .file-upload.dragover { border-color: var(--primary-purple); background: rgba(167,139,250,0.1); }
    .upload-icon { font-size: 3rem; color: var(--gray-400); margin-bottom: var(--space-4); }
    .upload-text { color: var(--gray-600); margin-bottom: var(--space-2); }
    .upload-hint { color: var(--gray-500); font-size: 0.9rem; }
    .file-input { display: none; }
    .preview-container {
      margin-top: var(--space-6); display: none;
    }
    .preview-image {
      max-width: 100%; max-height: 300px; border-radius: var(--radius-lg);
      box-shadow: var(--shadow); margin-bottom: var(--space-4);
    }
    .file-info {
      background: var(--gray-50); padding: var(--space-4); border-radius: var(--radius-lg);
      margin-bottom: var(--space-4);
    }
    .file-info-item {
      display: flex; justify-content: space-between; margin-bottom: var(--space-2);
    }
    .file-info-item:last-child { margin-bottom: 0; }
    .file-info-label { font-weight: 600; color: var(--gray-700); }
    .file-info-value { color: var(--gray-600); }
    .convert-btn {
      background: linear-gradient(135deg, var(--primary-purple), var(--primary-green));
      color: var(--white); border: none; padding: var(--space-4) var(--space-8);
      border-radius: var(--radius-lg); font-weight: 600; font-size: 1rem;
      cursor: pointer; transition: transform var(--transition-normal);
      width: 100%; margin-top: var(--space-4);
    }
    .convert-btn:hover { transform: translateY(-2px); }
    .convert-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .download-section {
      margin-top: var(--space-6); display: none;
    }
    .download-btn {
      background: var(--dark-blue); color: var(--white); border: none;
      padding: var(--space-3) var(--space-6); border-radius: var(--radius-lg);
      font-weight: 600; text-decoration: none; display: inline-block;
      transition: background var(--transition-normal);
    }
    .download-btn:hover { background: var(--primary-purple); }
    .quality-control {
      margin-top: var(--space-4); display: none;
    }
    .quality-options {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-3);
      margin-top: var(--space-3);
    }
    .quality-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3);
      border: 2px solid var(--gray-300);
      border-radius: var(--radius-lg);
      background: var(--white);
      cursor: pointer;
      transition: all var(--transition-normal);
      font-weight: 600;
      color: var(--gray-700);
    }
    .quality-btn:hover {
      border-color: var(--primary-purple);
      background: rgba(167, 139, 250, 0.05);
      transform: translateY(-2px);
    }
    .quality-btn.active {
      border-color: var(--primary-purple);
      background: linear-gradient(135deg, rgba(167,139,250,0.15), rgba(212,255,101,0.15));
      color: var(--primary-purple);
      box-shadow: 0 2px 8px rgba(167,139,250,0.3);
    }
    .quality-btn-label {
      font-size: 0.95rem;
      font-weight: 600;
    }
    .quality-btn-size {
      font-size: 0.75rem;
      color: var(--gray-500);
      font-weight: 400;
    }
    .quality-btn.active .quality-btn-size {
      color: var(--primary-purple);
    }
    .back-btn {
      background: var(--gray-200); color: var(--gray-700); border: none;
      padding: var(--space-2) var(--space-4); border-radius: var(--radius-lg);
      font-weight: 600; text-decoration: none; display: inline-block;
      margin-bottom: var(--space-4); transition: background var(--transition-normal);
    }
    .back-btn:hover { background: var(--gray-300); }

    @media (max-width: 600px) {
      .converter-hero { 
        padding: 4rem 1rem 2rem 1rem; 
      }
      .converter-hero h1 { 
        font-size: 1.6rem; 
        margin-bottom: var(--space-2);
      }
      .converter-hero p { 
        font-size: 1rem; 
        line-height: 1.5;
      }
      .format-selector { 
        grid-template-columns: 1fr; 
        gap: var(--space-3); 
        text-align: center;
      }
      .arrow-icon { 
        transform: rotate(90deg); 
        font-size: 1.2rem;
      }
      .converter-card {
        padding: var(--space-6);
        margin: 1rem 0.5rem;
      }
      .file-upload {
        padding: var(--space-6);
      }
      .upload-icon { 
        font-size: 2.5rem; 
        margin-bottom: var(--space-3); 
      }
      .upload-text { 
        font-size: 0.95rem; 
        margin-bottom: var(--space-2); 
      }
      .upload-hint { 
        font-size: 0.85rem; 
      }
      .convert-btn {
        padding: var(--space-4) var(--space-6);
        font-size: 0.95rem;
      }
      .download-btn {
        padding: var(--space-3) var(--space-4);
        font-size: 0.9rem;
        margin-bottom: var(--space-2);
        display: block;
        width: 100%;
        text-align: center;
      }
      .quality-options {
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-2);
      }
      .quality-btn {
        padding: var(--space-2);
        font-size: 0.85rem;
      }
      .quality-btn-label {
        font-size: 0.85rem;
      }
      .quality-btn-size {
        font-size: 0.7rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar" id="navbar">
    <div class="nav-container">
      <div class="nav-logo">
        <a href="../index.html#hero">
          <img src="../images/ZenMiniLogo-cutout.png" alt="Zen Solutions">
        </a>
      </div>
      <div class="nav-menu" id="navMenu">
        <a href="../index.html#about" class="nav-link" data-en="About" data-es="Nosotros">Nosotros</a>
        <a href="../index.html#services" class="nav-link" data-en="Services" data-es="Servicios">Servicios</a>
        <a href="../index.html#work" class="nav-link" data-en="Work" data-es="Trabajo">Trabajo</a>
        <a href="tools.html" class="nav-link" data-en="Tools" data-es="Herramientas">Herramientas</a>
        <a href="../index.html#contact" class="nav-link" data-en="Contact" data-es="Contacto">Contacto</a>
      </div>
      <div class="nav-toggle" id="navToggle">
        <span></span><span></span><span></span>
      </div>
    </div>
  </nav>

  <header class="converter-hero">
    <h1 data-en="Image Converter" data-es="Convertidor de Im√°genes">Convertidor de Im√°genes</h1>
    <p data-en="Convert between JPG, PNG, WebP and other image formats. Choose your source and target formats below." data-es="Convierte entre JPG, PNG, WebP y otros formatos de imagen. Elige tus formatos origen y destino abajo.">Convierte entre JPG, PNG, WebP y otros formatos de imagen. Elige tus formatos origen y destino abajo.</p>
  </header>

  <main class="converter-container">
    <a href="tools.html" class="back-btn" data-en="‚Üê Back to Tools" data-es="‚Üê Volver a Herramientas">‚Üê Volver a Herramientas</a>
    
    <div class="converter-card">
      <div class="format-selector">
        <div class="format-group">
          <label data-en="Source Format" data-es="Formato Origen">Formato Origen</label>
          <select id="sourceFormat" class="format-select">
            <option value="jpg" data-en="JPG" data-es="JPG">JPG</option>
            <option value="png" data-en="PNG" data-es="PNG">PNG</option>
            <option value="webp" data-en="WebP" data-es="WebP">WebP</option>
            <option value="bmp" data-en="BMP" data-es="BMP">BMP</option>
            <option value="gif" data-en="GIF" data-es="GIF">GIF</option>
            <option value="heic" data-en="HEIC" data-es="HEIC">HEIC</option>
          </select>
        </div>
        
        <div class="arrow-icon">‚Üí</div>
        
        <div class="format-group">
          <label data-en="Target Format" data-es="Formato Destino">Formato Destino</label>
          <select id="targetFormat" class="format-select">
            <option value="png" data-en="PNG" data-es="PNG">PNG</option>
            <option value="jpg" data-en="JPG" data-es="JPG">JPG</option>
            <option value="webp" data-en="WebP" data-es="WebP">WebP</option>
            <option value="bmp" data-en="BMP" data-es="BMP">BMP</option>
            <option value="gif" data-en="GIF" data-es="GIF">GIF</option>
            <option value="heic" data-en="HEIC" data-es="HEIC">HEIC</option>
          </select>
        </div>
      </div>

      <div class="file-upload" id="fileUpload">
        <div class="upload-icon">üìÅ</div>
        <div class="upload-text" data-en="Click to select images or drag and drop" data-es="Haz clic para seleccionar im√°genes o arrastra y suelta">Haz clic para seleccionar im√°genes o arrastra y suelta</div>
        <div class="upload-hint" data-en="Supports JPG, PNG, WebP, BMP, GIF, HEIC" data-es="Soporta JPG, PNG, WebP, BMP, GIF, HEIC">Soporta JPG, PNG, WebP, BMP, GIF, HEIC</div>
        <input type="file" id="fileInput" class="file-input" accept="image/*,.heic,.heif" multiple>
      </div>

      <div class="quality-control" id="qualityControl">
        <label data-en="Quality (for lossy formats)" data-es="Calidad (para formatos con p√©rdida)">Calidad (para formatos con p√©rdida)</label>
        <div class="quality-options" id="qualityOptions">
          <button class="quality-btn" data-quality="0.5" data-label="Muy baja">
            <span class="quality-btn-label">Muy baja</span>
            <span class="quality-btn-size" id="size-very-low">-</span>
          </button>
          <button class="quality-btn" data-quality="0.7" data-label="Baja">
            <span class="quality-btn-label">Baja</span>
            <span class="quality-btn-size" id="size-low">-</span>
          </button>
          <button class="quality-btn active" data-quality="0.85" data-label="Normal">
            <span class="quality-btn-label">Normal</span>
            <span class="quality-btn-size" id="size-normal">-</span>
          </button>
          <button class="quality-btn" data-quality="0.95" data-label="Excelente">
            <span class="quality-btn-label">Excelente</span>
            <span class="quality-btn-size" id="size-excellent">-</span>
          </button>
        </div>
      </div>

      <button id="convertBtn" class="convert-btn" disabled data-en="Convert Images" data-es="Convertir Im√°genes">Convertir Im√°genes</button>
    </div>


    <div class="download-section" id="downloadSection">
      <h3 data-en="Download Converted Images" data-es="Descargar Im√°genes Convertidas">Descargar Im√°genes Convertidas</h3>
      <div id="downloadLinks"></div>
    </div>
  </main>

  <div class="tools-footer">
    &copy; 2025 Zen Solutions. <span data-en="Powered by browser technology." data-es="Desarrollado con tecnolog√≠a Zen Solutions.">Desarrollado con tecnolog√≠a Zen Solutions.</span>
    <a href="../index.html" style="color:var(--primary-purple);text-decoration:none;" data-en="Back to Home" data-es="Volver al Inicio">Volver al Inicio</a>
  </div>

  <script src="../zen-analytics-stub.js"></script>
  <script src="../firebase-config.js"></script>
  <script type="module" src="../analytics.js"></script>
  <script src="freemium-system.js"></script>
  <script>
    // Mobile navbar
    (function initConverterNavbar(){
      const navToggle = document.getElementById('navToggle');
      const navMenu = document.getElementById('navMenu');
      if (navToggle && navMenu) {
        navToggle.addEventListener('click', () => {
          navMenu.classList.toggle('active');
          navToggle.classList.toggle('active');
          document.body.style.overflow = navMenu.classList.contains('active') ? 'hidden' : '';
        });
        navMenu.querySelectorAll('a').forEach(a => a.addEventListener('click', () => {
          navMenu.classList.remove('active');
          navToggle.classList.remove('active');
          document.body.style.overflow = '';
        }));
      }
    })();

    // Language handling
    function detectLanguage() {
      const userLang = navigator.language || navigator.userLanguage || '';
      return userLang.toLowerCase().startsWith('es') ? 'es' : 'en';
    }
    function setLanguage(lang) {
      document.documentElement.lang = lang;
      document.querySelectorAll('[data-en]').forEach(el => {
        const text = el.getAttribute(`data-${lang}`);
        if (text) el.textContent = text;
      });
    }

    // Initialize from URL parameters
    function initializeFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const from = urlParams.get('from');
      const to = urlParams.get('to');
      
      if (from) {
        const sourceSelect = document.getElementById('sourceFormat');
        const option = sourceSelect.querySelector(`option[value="${from}"]`);
        if (option) {
          sourceSelect.value = from;
        }
      }
      
      if (to) {
        const targetSelect = document.getElementById('targetFormat');
        const option = targetSelect.querySelector(`option[value="${to}"]`);
        if (option) {
          targetSelect.value = to;
        }
      }
      
      updateQualityControl();
      updateQualityEstimate();
    }

    // Update quality control visibility
    function updateQualityControl() {
      const targetFormat = document.getElementById('targetFormat').value;
      const qualityControl = document.getElementById('qualityControl');
      const lossyFormats = ['jpg', 'webp'];
      
      if (lossyFormats.includes(targetFormat)) {
        qualityControl.style.display = 'block';
      } else {
        qualityControl.style.display = 'none';
      }
    }

    // File handling
    let selectedFiles = [];

    const fileUpload = document.getElementById('fileUpload');
    const fileInput = document.getElementById('fileInput');
    const convertBtn = document.getElementById('convertBtn');
    const previewContainer = document.getElementById('previewContainer');
    const previewImages = document.getElementById('previewImages');
    const fileInfo = document.getElementById('fileInfo');
    const downloadSection = document.getElementById('downloadSection');
    const downloadLinks = document.getElementById('downloadLinks');

    // File upload events
    fileUpload.addEventListener('click', () => fileInput.click());
    fileUpload.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileUpload.classList.add('dragover');
    });
    fileUpload.addEventListener('dragleave', () => {
      fileUpload.classList.remove('dragover');
    });
    fileUpload.addEventListener('drop', (e) => {
      e.preventDefault();
      fileUpload.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    function handleFiles(files) {
      const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
      
      // Verificar l√≠mites freemium
      const canUse = freemiumSystem.canUseTool('imageConverter', imageFiles.length);
      
      if (!canUse.allowed) {
        freemiumSystem.showUpgradeModal('imageConverter', canUse.reason);
        return;
      }
      
      // Aplicar l√≠mite seg√∫n el plan
      const stats = freemiumSystem.getUsageStats('imageConverter');
      const maxImages = stats.isPremium ? 20 : 3;
      
      if (imageFiles.length > maxImages) {
        alert(`M√°ximo ${maxImages} im√°genes por conversi√≥n. Solo se procesar√°n las primeras ${maxImages}.`);
        selectedFiles = imageFiles.slice(0, maxImages);
      } else {
        selectedFiles = imageFiles;
      }
      
      if (selectedFiles.length > 0) {
        convertBtn.disabled = false;
        autoDetectFormat(selectedFiles[0]);
        updateUploadArea();
        updateQualityEstimate();
      } else {
        convertBtn.disabled = true;
        resetUploadArea();
        // Reset size estimates
        document.querySelectorAll('.quality-btn-size').forEach(el => {
          el.textContent = '-';
        });
      }
    }

    function autoDetectFormat(file) {
      const fileType = file.type.toLowerCase();
      const fileName = file.name.toLowerCase();
      const sourceFormat = document.getElementById('sourceFormat');
      
      // Check file extension first (for HEIC files that might not have proper MIME type)
      if (fileName.endsWith('.heic') || fileName.endsWith('.heif') || fileType.includes('heic') || fileType.includes('heif')) {
        sourceFormat.value = 'heic';
      } else if (fileType.includes('jpeg') || fileType.includes('jpg') || fileName.endsWith('.jpg') || fileName.endsWith('.jpeg')) {
        sourceFormat.value = 'jpg';
      } else if (fileType.includes('png') || fileName.endsWith('.png')) {
        sourceFormat.value = 'png';
      } else if (fileType.includes('webp') || fileName.endsWith('.webp')) {
        sourceFormat.value = 'webp';
      } else if (fileType.includes('bmp') || fileName.endsWith('.bmp')) {
        sourceFormat.value = 'bmp';
      } else if (fileType.includes('gif') || fileName.endsWith('.gif')) {
        sourceFormat.value = 'gif';
      }
      
      updateQualityControl();
      updateQualityEstimate();
    }

    function updateUploadArea() {
      if (selectedFiles.length > 0) {
        let imagesHTML = '';
        let fileNames = [];
        
        selectedFiles.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            // Check if mobile for responsive image sizing
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                            ('ontouchstart' in window) || 
                            (navigator.maxTouchPoints > 0);
            
            const imageSize = isMobile ? '60px' : '80px';
            const fontSize = isMobile ? '0.7rem' : '0.8rem';
            const maxWidth = isMobile ? '60px' : '80px';
            
            imagesHTML += `
              <div style="display: inline-block; margin: 5px; text-align: center;">
                <img src="${e.target.result}" style="width: ${imageSize}; height: ${imageSize}; object-fit: cover; border-radius: var(--radius-lg); border: 2px solid var(--gray-200);" alt="Imagen ${index + 1}">
                <div style="font-size: ${fontSize}; color: var(--gray-600); margin-top: 4px; max-width: ${maxWidth}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.name}</div>
              </div>
            `;
            
            // Update the display when all images are loaded
            if (imagesHTML.split('<div style="display: inline-block').length - 1 === selectedFiles.length) {
              fileUpload.innerHTML = `
                <div style="margin-bottom: var(--space-4);">
                  ${imagesHTML}
                </div>
                <div class="upload-text">${selectedFiles.length} imagen${selectedFiles.length > 1 ? 'es' : ''} seleccionada${selectedFiles.length > 1 ? 's' : ''}</div>
                <div class="upload-hint">Haz clic para cambiar o arrastra m√°s im√°genes (m√°x. 5)</div>
              `;
              
              // Re-add click event listener after updating innerHTML
              fileUpload.addEventListener('click', () => fileInput.click());
            }
          };
          reader.readAsDataURL(file);
        });
      }
    }

    function resetUploadArea() {
      fileUpload.innerHTML = `
        <div class="upload-icon">üìÅ</div>
        <div class="upload-text" data-en="Click to select images or drag and drop (max 5)" data-es="Haz clic para seleccionar im√°genes o arrastra y suelta (m√°x. 5)">Haz clic para seleccionar im√°genes o arrastra y suelta (m√°x. 5)</div>
        <div class="upload-hint" data-en="Supports JPG, PNG, WebP, BMP, GIF" data-es="Soporta JPG, PNG, WebP, BMP, GIF">Soporta JPG, PNG, WebP, BMP, GIF</div>
      `;
    }


    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Conversion
    convertBtn.addEventListener('click', async () => {
      if (selectedFiles.length === 0) return;

      convertBtn.disabled = true;
      convertBtn.textContent = 'Convirtiendo...';

      const sourceFormat = document.getElementById('sourceFormat').value;
      const targetFormat = document.getElementById('targetFormat').value;
      const activeQualityBtn = document.querySelector('.quality-btn.active');
      const quality = activeQualityBtn ? parseFloat(activeQualityBtn.getAttribute('data-quality')) : 0.85;

      const convertedFiles = [];

      for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];
        try {
          const convertedFile = await convertImage(file, sourceFormat, targetFormat, quality);
          convertedFiles.push({
            original: file,
            converted: convertedFile,
            name: file.name.replace(/\.[^/.]+$/, '') + '.' + targetFormat
          });
        } catch (error) {
          console.error('Error converting file:', error);
        }
      }

      // Registrar uso en el sistema freemium
      freemiumSystem.recordUsage('imageConverter');
      
      // Auto download all converted files (only on desktop)
      autoDownloadFiles(convertedFiles);
      
      showDownloadLinks(convertedFiles);
      convertBtn.disabled = false;
      convertBtn.textContent = 'Convertir Im√°genes';
      
      // Show success message
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                      ('ontouchstart' in window) || 
                      (navigator.maxTouchPoints > 0);
      
      if (isMobile) {
        // Show mobile-specific success message
        const successMessage = document.createElement('div');
        successMessage.style.cssText = `
          background: rgba(34, 197, 94, 0.1);
          border: 1px solid rgba(34, 197, 94, 0.3);
          border-radius: var(--radius-lg);
          padding: var(--space-4);
          margin-top: var(--space-4);
          text-align: center;
          color: var(--dark-blue);
          font-size: 0.9rem;
        `;
        successMessage.innerHTML = '‚úÖ <strong>¬°Conversi√≥n exitosa!</strong> Tus im√°genes est√°n listas para descargar.';
        downloadSection.insertBefore(successMessage, downloadLinks);
      }
    });

    function autoDownloadFiles(convertedFiles) {
      // Check if we're on mobile/touch device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                      ('ontouchstart' in window) || 
                      (navigator.maxTouchPoints > 0);
      
      if (isMobile) {
        // On mobile, don't auto-download, just show the download section
        console.log('Mobile device detected - showing download links instead of auto-downloading');
        return;
      }
      
      if (convertedFiles.length === 1) {
        // Single file - download immediately
        const fileData = convertedFiles[0];
        const link = document.createElement('a');
        link.href = URL.createObjectURL(fileData.converted);
        link.download = fileData.name;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Clean up the URL after a short delay
        setTimeout(() => {
          URL.revokeObjectURL(link.href);
        }, 1000);
      } else {
        // Multiple files - download with small delay between each
        convertedFiles.forEach((fileData, index) => {
          setTimeout(() => {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(fileData.converted);
            link.download = fileData.name;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Clean up the URL after a short delay
            setTimeout(() => {
              URL.revokeObjectURL(link.href);
            }, 1000);
          }, index * 800); // 800ms delay between downloads
        });
      }
    }

    async function convertImage(file, sourceFormat, targetFormat, quality) {
      return new Promise((resolve, reject) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();

        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;

          // For PNG to JPG conversion, add white background
          if (sourceFormat === 'png' && targetFormat === 'jpg') {
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
          }

          ctx.drawImage(img, 0, 0);

          // Handle HEIC output format (convert to JPEG since browsers don't support HEIC output)
          let outputFormat = targetFormat;
          if (targetFormat === 'heic') {
            outputFormat = 'jpg'; // Convert HEIC to JPG for browser compatibility
          }

          const mimeType = `image/${outputFormat === 'jpg' ? 'jpeg' : outputFormat}`;
          const dataURL = canvas.toDataURL(mimeType, quality);
          
          // Convert data URL to blob
          fetch(dataURL)
            .then(res => res.blob())
            .then(blob => resolve(blob))
            .catch(reject);
        };

        img.onerror = (error) => {
          console.error('Error loading image:', error);
          // For HEIC files, try to load as regular image
          if (sourceFormat === 'heic') {
            console.log('Trying to load HEIC file as regular image...');
            img.src = URL.createObjectURL(file);
          } else {
            reject(error);
          }
        };
        
        img.src = URL.createObjectURL(file);
      });
    }

    function showDownloadLinks(convertedFiles) {
      downloadSection.style.display = 'block';
      downloadLinks.innerHTML = '';

      // Check if we're on mobile
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                      ('ontouchstart' in window) || 
                      (navigator.maxTouchPoints > 0);

      if (isMobile) {
        // Check if it's an iPhone/iOS device
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        // Add mobile-specific message
        const mobileMessage = document.createElement('div');
        mobileMessage.style.cssText = `
          background: rgba(167, 139, 250, 0.1);
          border: 1px solid rgba(167, 139, 250, 0.3);
          border-radius: var(--radius-lg);
          padding: var(--space-4);
          margin-bottom: var(--space-4);
          text-align: center;
          color: var(--dark-blue);
          font-size: 0.9rem;
        `;
        
        let messageText = 'üì± <strong>Dispositivo m√≥vil detectado:</strong> Toca los botones de abajo para descargar cada imagen.';
        if (isIOS) {
          messageText += '<br><br>üçé <strong>iPhone/iPad:</strong> Si tienes problemas con HEIC, aseg√∫rate de seleccionar "HEIC" como formato origen.';
        }
        
        mobileMessage.innerHTML = messageText;
        downloadLinks.appendChild(mobileMessage);
      }

      convertedFiles.forEach((fileData, index) => {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(fileData.converted);
        link.download = fileData.name;
        link.className = 'download-btn';
        link.textContent = `üì• Descargar ${fileData.name}`;
        link.style.marginRight = isMobile ? '0' : '10px';
        link.style.marginBottom = '10px';
        
        // Add click handler for better mobile support
        link.addEventListener('click', (e) => {
          // For mobile, we need to handle the download differently
          if (isMobile) {
            e.preventDefault();
            
            // Try multiple download methods for better mobile compatibility
            try {
              // Method 1: Direct download (works in some mobile browsers)
              const directLink = document.createElement('a');
              directLink.href = link.href;
              directLink.download = link.download;
              directLink.style.display = 'none';
              document.body.appendChild(directLink);
              directLink.click();
              document.body.removeChild(directLink);
              
              // Method 2: If direct download fails, open in new tab
              setTimeout(() => {
                const newWindow = window.open(link.href, '_blank');
                if (newWindow) {
                  setTimeout(() => {
                    newWindow.close();
                  }, 2000);
                }
              }, 500);
              
            } catch (error) {
              console.log('Direct download failed, trying alternative method');
              // Fallback: Open in new tab
              const newWindow = window.open(link.href, '_blank');
              if (newWindow) {
                setTimeout(() => {
                  newWindow.close();
                }, 2000);
              }
            }
          }
        });
        
        downloadLinks.appendChild(link);
      });

      // Add download all button
      if (convertedFiles.length > 1) {
        const downloadAllBtn = document.createElement('button');
        downloadAllBtn.className = 'download-btn';
        downloadAllBtn.textContent = 'üì¶ Descargar Todo';
        downloadAllBtn.style.marginTop = '10px';
        downloadAllBtn.addEventListener('click', () => {
          if (isMobile) {
            // On mobile, download one by one with user interaction
            convertedFiles.forEach((fileData, index) => {
              setTimeout(() => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(fileData.converted);
                link.download = fileData.name;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
              }, index * 1000); // 1 second delay between downloads on mobile
            });
          } else {
            // On desktop, download all at once
            convertedFiles.forEach(fileData => {
              const link = document.createElement('a');
              link.href = URL.createObjectURL(fileData.converted);
              link.download = fileData.name;
              link.style.display = 'none';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            });
          }
        });
        downloadLinks.appendChild(downloadAllBtn);
      }
    }

    // Format change events
    document.getElementById('sourceFormat').addEventListener('change', () => {
      updateQualityControl();
      updateQualityEstimate();
    });
    document.getElementById('targetFormat').addEventListener('change', () => {
      updateQualityControl();
      updateQualityEstimate();
    });

    // Initialize quality buttons
    function initQualityButtons() {
      const qualityButtons = document.querySelectorAll('.quality-btn');
      qualityButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          qualityButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          updateQualityEstimate();
        });
      });
    }

    // Calculate and update estimated file sizes
    async function updateQualityEstimate() {
      if (selectedFiles.length === 0) return;
      
      const targetFormat = document.getElementById('targetFormat').value;
      const lossyFormats = ['jpg', 'webp'];
      
      if (!lossyFormats.includes(targetFormat)) {
        // Hide size estimates for lossless formats
        document.querySelectorAll('.quality-btn-size').forEach(el => {
          el.textContent = '-';
        });
        return;
      }

      const qualityButtons = document.querySelectorAll('.quality-btn');
      const firstFile = selectedFiles[0];
      
      // Show loading state
      qualityButtons.forEach(btn => {
        const sizeElement = btn.querySelector('.quality-btn-size');
        if (sizeElement) {
          sizeElement.textContent = '...';
        }
      });
      
      // Map format to correct MIME type
      const mimeTypeMap = {
        'jpg': 'image/jpeg',
        'jpeg': 'image/jpeg',
        'webp': 'image/webp'
      };
      const mimeType = mimeTypeMap[targetFormat] || `image/${targetFormat}`;
      
      // Create a temporary canvas to estimate sizes
      const img = new Image();
      const reader = new FileReader();
      
      reader.onload = (e) => {
        img.onload = () => {
          // Process each quality option separately with its own canvas
          const promises = Array.from(qualityButtons).map(btn => {
            return new Promise((resolve) => {
              const quality = parseFloat(btn.getAttribute('data-quality'));
              const sizeId = btn.querySelector('.quality-btn-size').id;
              
              // Create a fresh canvas for each quality to avoid conflicts
              const canvas = document.createElement('canvas');
              canvas.width = img.width;
              canvas.height = img.height;
              const ctx = canvas.getContext('2d');
              
              // Fill with white background for JPG (transparency handling)
              if (targetFormat === 'jpg' || targetFormat === 'jpeg') {
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
              }
              
              ctx.drawImage(img, 0, 0);
              
              canvas.toBlob((blob) => {
                if (blob) {
                  const estimatedSize = blob.size * selectedFiles.length;
                  const sizeElement = document.getElementById(sizeId);
                  if (sizeElement) {
                    sizeElement.textContent = formatFileSize(estimatedSize);
                  }
                } else {
                  const sizeElement = document.getElementById(sizeId);
                  if (sizeElement) {
                    sizeElement.textContent = '-';
                  }
                }
                resolve();
              }, mimeType, quality);
            });
          });
          
          Promise.all(promises).catch(err => {
            console.error('Error estimating sizes:', err);
            qualityButtons.forEach(btn => {
              const sizeElement = btn.querySelector('.quality-btn-size');
              if (sizeElement && sizeElement.textContent === '...') {
                sizeElement.textContent = '-';
              }
            });
          });
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(firstFile);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      setLanguage(detectLanguage());
      initializeFromURL();
      initQualityButtons();
    });
  </script>
</body>
</html>
